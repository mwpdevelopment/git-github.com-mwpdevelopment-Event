<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>e Vent</title>


    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
        integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    
        <script src="./store/js/common.js"></script>

    <!-- Estilos personalizados -->
    <link rel="stylesheet" type="text/css" href="./style.css"  />
    <style>

    </style>
</head>

<body onload="Load();">
     <!--NAVEGACION-->
     <div class="menu">
        <nav class="navbar navbar-expand-lg navbar-light bg-light">
            <div class="container-fluid">
                <a class="navbar-brand" href="#">e-Vent</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                    data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent"
                    aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                        <li class="nav-item">
                            <a class="nav-link active" aria-current="page" href="eventos.html">Crear Evento</a>
                        </li>

                        <li class="nav-item">
                            <a class="nav-link " aria-current="page" href="eventos.html">Todos los Eventos</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link " aria-current="page" href="miseventos.html">Mis Eventos</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link " aria-current="page" href="registradoeventos.html">Registro de eventos</a>
                        </li>
                    </ul>

                    <div>
                        <a href="index.html" id="nombreusuario">Entrar</a>

                        &nbsp;
                        <span class="image"><img class="kpmg-iconuser" style="height: 30px;"
                                src="images/iconUser.png" /></span>
                        &nbsp;
                        <a class="navbar-brand disabled" href="./login.html">
                            <i class="bi bi-box-arrow-right icon_logout"> </i>
                        </a>
                    </div>
                </div>
            </div>
        </nav>
   
    </div>
    <!--FIN DE NAVEGACION-->

    <div>
        <div class="p-4">
            <div class="container">
                <div class="row">
                    
                    <div class="col-lg-12 col-md-12 col-sm-8 col-lg-3 mx-auto">
                        <div class="form-container">
                            <div class="title">
                                Crear un Evento
                            </div>
                            
                            <div class="form-group mt-3">
                                <label class="mb-2" for="name">Título</label>
                                <input class="form-control " id="name" name="name" oninput="checkrequiredField('name')"
                                    placeholder="Indícanos cómo se llama el evento" />
                                <p id="error_name" class="text-danger d-none">Campo requerido.</p>
                            </div>
                            <div class="form-group mt-3">
                                <label class="mb-2" for="description">Descripción</label>

                                <textarea class="form-control " id="description" name="description" oninput="checkrequiredField('description')"
                                    rows="5"
                                    placeholder="Cúrratelo un poco y dinos de qué trata el evento."></textarea>
                                <p id="error_description" class="text-danger d-none">Campo requerido.</p>
                            </div>
                            <div class="form-group mt-3">
                                <label class="mb-2" for="dateevent">Fecha del Evento</label>
                                <input class="form-control " id="dateevent" name="dateevent" oninput="checkrequiredField('dateevent')"
                                    type="date" />
                                <p id="error_dateevent" class="text-danger d-none">Campo requerido.</p>
                            </div>
                            <div class="form-group mt-3">
                                <label class="mb-2">Imágenes</label>
                                <input type="file" class="form-control-file" id="images" name="images" capture multiple />
                                <small class="form-text text-muted">Selecciona una o varias imágenes para el
                                    evento.</small>
                            </div>
                            <div class="form-group mt-3">
                                <button class="btn btn-outline-primary btn-lg w-100 mt-4" onclick="submitForm()">Aceptar</button>
                            </div>
                        

                            <!-- Carrusel para mostrar las imágenes -->
                            <div id="imageCarousel" class="carousel slide mt-5" data-bs-ride="carousel">
                                <div class="carousel-inner" id="carrusel">
                                    <!-- Aquí se añadirán las imágenes dinámicamente -->
                                </div>
                                <button class="carousel-control-prev" type="button" data-bs-target="#imageCarousel"
                                    data-bs-slide="prev">
                                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                    <span class="visually-hidden">Anterior</span>
                                </button>
                                <button class="carousel-control-next" type="button" data-bs-target="#imageCarousel"
                                    data-bs-slide="next">
                                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                    <span class="visually-hidden">Siguiente</span>
                                </button>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Enlace al archivo JavaScript de Bootstrap -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@9"></script>
    <script type = "text/JavaScript" src = " https://MomentJS.com/downloads/moment.js"></script>

    <script>
        // Enlazamos el envento CHANGE a la función que acumula imaganes.
        const inputElement = document.getElementById('images');
        inputElement.addEventListener('change', handleImageUpload);

        function handleImageUpload(event) {
            const fileList = event.target.files;
            var active="active";

            // Recorre cada archivo seleccionado
            for (let i = 0; i < fileList.length; i++) {
                const file = fileList[i];


                const fileurl = URL.createObjectURL(file);

                const htmlcarrusel = "<div class='carousel-item "+active+"'>"+
                                     "  <img src='"+fileurl+"' class='d-block w-100' >"+
                                     "</div>";

                document.getElementById("carrusel").innerHTML+=htmlcarrusel;
                active="";
            }

        }

        async function submitForm() {
            try {
                // Obtener los valores de los campos del formulario
                const name = document.getElementById('name').value;
                const description = document.getElementById('description').value;
                const dateevent = document.getElementById('dateevent').value;
                const images = document.getElementById('images').files;

                // Validar campos requeridos
                if (name === "" || description === "" || dateevent === "") {                
                    checkrequiredField('name');
                    checkrequiredField('description') 
                    checkrequiredField('dateevent');
                    Swal.fire("Por favor, completa todos los campos del formulario.");
                    return;
                }
                var evento = {
                    Id: 0,
                    Nombre: name,
                    Descripcion: description,
                    FechaEvento: dateevent,
                    Propietario: 1, // TODO: cambiar por el usuario.
                    Imagenes: [],
                    UsuariosRegistrados: []
                };
         
                //const response = await fetch('https://apievent.azurewebsites.net/api/CreateUpdateEvent', {
                const response = await fetch('https://apievent.azurewebsites.net/api/CreateUpdateEvent', {
                    method: 'POST',
                    body:  JSON.stringify(evento),
                });

                // Manejar la respuesta de la API
                if (response.ok) {
                    const result = await response.text();
                    console.log('Respuesta:', result);
                    // Agregar las imágenes seleccionadas al FormData
                    for (let i = 0; i < images.length; i++) {
                        var nombre = await uploadFile(images[i]);                        
                        if(nombre!=""){
                            var imagenes = {                       
                                EventoId:result,
                                Principal:true,
                                RutaImagen:nombre,
                                Data: images[i]
                                };
                            await uploadImage(imagenes);
                        }

                    }
                    Swal.fire('Evento creado exitosamente.');
                    window.location.replace('verevento.html?'+result.id);
                } else {
                    Swal.fire('Error en la solicitud. Por favor, intenta nuevamente.');

                }
            } catch (error) {
                console.error('Error en la solicitud:', error);
                Swal.fire('Error en la solicitud. Por favor, intenta nuevamente.');
            }
        }
        async function uploadImage(imagen) {
            const response = await fetch("https://apievent.azurewebsites.net/api/CreateUpdateImg", {
                method: "POST",
                body: JSON.stringify(imagen),
            });

            if (response.ok) {
                console.log("Archivo subido con éxito.");
            } else {
                console.error("Error al subir el archivo:", response.status);
            }
        }
        async function uploadFile(file) {
            const formData = new FormData();
            formData.append("file", file);

            const response = await fetch("https://apievent.azurewebsites.net/api/FileUpload", {
                method: "POST",
                body: formData,
            });

            if (response.ok) {
                const result = await response.text();
                return result;
            } else {
                console.error("Error al subir el archivo:", response.status);
                return "";
            }
        }

        
        function checkPasswordMatch() {
            const password = document.getElementById('password').value;
            const repassword = document.getElementById('repassword').value;
            const errorText = document.getElementById('passwordMatchError');

            if (password === repassword) {
                errorText.classList.add('d-none');  // Oculta el mensaje de error
            } else {
                errorText.classList.remove('d-none');  // Muestra el mensaje de error
            }
        }

      
    </script>
</body>

</html>